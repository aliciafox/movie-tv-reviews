<script>
    const apiKey = '3f2fe61ae14a656e1ad11ff26b0d0594'; 
    const apiUrl = 'https://api.themoviedb.org/3/';
    const genresEndpoint = 'genre/movie/list?api_key=' + apiKey + '&language=en-US';
    
    let currentPage = 1;
    let totalPages = 1;
    let allGenres = [];

    async function fetchGenres() {
        const response = await fetch(apiUrl + genresEndpoint);
        const data = await response.json();
        allGenres = data.genres;
        
        const genreSelect = document.getElementById('genreSelect');
        data.genres.forEach(genre => {
            const option = document.createElement('option');
            option.value = genre.id;
            option.textContent = genre.name;
            genreSelect.appendChild(option);
        });
    }

    async function fetchResults(page = 1) {
        currentPage = page;
        const searchQuery = document.getElementById('searchInput').value;
        const genre = document.getElementById('genreSelect').value;
        const year = document.getElementById('yearInput').value;
        const rating = document.getElementById('ratingInput').value;

        let url = apiUrl + 'search/movie?api_key=' + apiKey + '&query=' + searchQuery + '&language=en-US&page=' + currentPage + '&include_adult=false';

        if (genre) url += '&with_genres=' + genre;
        if (year) url += '&year=' + year;
        if (rating) url += '&vote_average.gte=' + rating;

        const response = await fetch(url);
        const data = await response.json();

        totalPages = data.total_pages;
        displayResults(data.results);
        displayPagination();
    }

    function displayResults(results) {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = '';

        if (results.length === 0) {
            resultsContainer.innerHTML = '<li>No results found</li>';
            return;
        }

        results.forEach(item => {
            const listItem = document.createElement('li');
            listItem.classList.add('result-item');
            
            const imageUrl = item.poster_path ? 'https://image.tmdb.org/t/p/w200' + item.poster_path : 'https://via.placeholder.com/100x150';
            const genres = getGenres(item.genre_ids);
            listItem.innerHTML = ` 
                <img src="${imageUrl}" alt="${item.title}">
                <div>
                    <h3>${item.title}</h3>
                    <p><strong>Genres:</strong> ${genres.join(', ') || 'N/A'}</p>
                    <p><strong>Release Date:</strong> ${item.release_date || 'N/A'}</p>
                    <p><strong>Rating:</strong> ${item.vote_average || 'N/A'}</p>
                    <p><strong>Overview:</strong> ${item.overview || 'No description available.'}</p>
                    <button onclick="fetchSimilarMovies(${item.id})">See Similar Movies</button>
                </div>
            `;
            resultsContainer.appendChild(listItem);
        });
    }

    function getGenres(genreIds) {
        return genreIds.map(id => {
            const genre = allGenres.find(genre => genre.id === id);
            return genre ? genre.name : 'Unknown';
        });
    }

    async function fetchSimilarMovies(movieId) {
        const response = await fetch(apiUrl + 'movie/' + movieId + '/similar?api_key=' + apiKey + '&language=en-US&page=1');
        const data = await response.json();
        displaySimilarMovies(data.results);
    }

    function displaySimilarMovies(similarMovies) {
        const similarMoviesContainer = document.getElementById('similarMovies');
        similarMoviesContainer.innerHTML = '<h3>Similar Movies You Might Like:</h3>';

        if (similarMovies.length === 0) {
            similarMoviesContainer.innerHTML = '<p>No similar movies found.</p>';
            return;
        }

        similarMovies.forEach(movie => {
            const movieItem = document.createElement('div');
            movieItem.classList.add('similar-movie-item');
            const imageUrl = movie.poster_path ? 'https://image.tmdb.org/t/p/w200' + movie.poster_path : 'https://via.placeholder.com/200x300';
            
            movieItem.innerHTML = `
                <img src="${imageUrl}" alt="${movie.title}">
                <p>${movie.title}</p>
            `;
            similarMoviesContainer.appendChild(movieItem);
        });
    }

    function displayPagination() {
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = '';

        const prevButton = document.createElement('button');
        prevButton.classList.add('page-btn');
        prevButton.textContent = 'Previous';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => fetchResults(currentPage - 1);
        paginationContainer.appendChild(prevButton);

        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.classList.add('page-btn');
            pageButton.textContent = i;
            pageButton.onclick = () => fetchResults(i);
            if (i === currentPage) {
                pageButton.classList.add('active');
            }
            paginationContainer.appendChild(pageButton);
        }

        const nextButton = document.createElement('button');
        nextButton.classList.add('page-btn');
        nextButton.textContent = 'Next';
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => fetchResults(currentPage + 1);
        paginationContainer.appendChild(nextButton);
    }

    // Initialize page and genres
    fetchGenres();
    fetchResults();  // This will load the first page on load
</script>
