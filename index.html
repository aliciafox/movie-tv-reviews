import time
import requests
from flask import Flask, request, render_template

app = Flask(__name__)

def fetch_items(api_url, search_params, total_items=200, items_per_page=50):
    all_items = []
    total_pages = total_items // items_per_page
    if total_items % items_per_page != 0:
        total_pages += 1

    # Loop through pages to fetch results
    for page in range(1, total_pages + 1):
        params = {**search_params, 'page': page, 'per_page': items_per_page}
        
        response = requests.get(api_url, params=params)
        
        if response.status_code == 200:
            data = response.json()
            all_items.extend(data['results'])
            print(f"Fetched {len(data['results'])} items from page {page}")
        else:
            print(f"Error fetching data from page {page}, Status Code: {response.status_code}")
            break
        
        # If we hit the rate limit, pause for 10 seconds
        if page % 40 == 0:
            print("Rate limit reached. Waiting for 10 seconds...")
            time.sleep(10)
    
    print(f"Total items fetched: {len(all_items)}")
    return all_items

@app.route('/search', methods=['GET'])
def search_movies():
    query = request.args.get('query', '')
    genre = request.args.get('genre', '')
    year = request.args.get('year', '')
    ratings = request.args.get('ratings', '')

    # Construct search parameters
    search_params = {
        'query': query,
        'genre': genre,
        'year': year,
        'ratings': ratings
    }

    # TMDb API URL - Make sure to replace with your own API key
    api_url = "https://api.themoviedb.org/3/search/movie?api_key=YOUR_API_KEY"
    
    # Fetch data from the API
    items = fetch_items(api_url, search_params)
    
    return render_template('results.html', items=items)

if __name__ == '__main__':
    app.run(debug=True)
